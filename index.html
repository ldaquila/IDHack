<html>
  <head>
  	<style>
  	section {
  	    float:left;
  	    padding:10px;	 	 
  	}
  	footer {
  		clear:both;
  	    text-align:left;
  	    padding:10px;	 	 
  	}
  	</style>
  <script type="text/javascript" src="https://www.google.com/jsapi"></script>
  <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
  <script>
  	var previous=""; var next="";
    google.load('visualization', '1', { 'packages': ['map', 'table'] });
    google.setOnLoadCallback(drawMap);
    google.setOnLoadCallback(drawTable);

    regions_map = new Object();
    countries_map = new Object();

    function drawMap() {
		var data = google.visualization.arrayToDataTable([
		['Country', 'Opportunities'],
		['China', 'China: \nagriculture: 0 \ncommunity economic development: 1 \neducation: 2 \nenvironment: 0 \nhealth: 4 \nyouth in development: 9'],
		['India', 'India: \nagriculture: 0 \ncommunity economic development: 1 \neducation: 2 \nenvironment: 0 \nhealth: 4 \nyouth in development: 9'],
		]);

		var options = { showTip: true };

		var map = new google.visualization.Map(document.getElementById('chart_div'));

		map.draw(data, options);

	}

	function drawTable(results) {
		var data = new google.visualization.DataTable();
		data.addColumn('string', 'Sector'); 
		data.addColumn('string', 'Title');
		data.addColumn('string', 'Country');
		data.addColumn('string', 'Region');
		data.addColumn('string', 'Start Date');
		rowsList = [];
		for (var i=0; i<results.length; i++) {
			rowsList.push([results[i]['sector'], "<a href='" + results[i]['opening_url'] + "'>" + results[i]['title'] + "</a>", countries_map[results[i]['country']], regions_map[results[i]['region']], results[i]['staging_start_date']]);
		}
		data.setColumnProperty(0, {allowHtml: true});
		data.addRows(rowsList);

		var table = new google.visualization.Table(document.getElementById('results_table'));

		table.draw(data, {allowHtml: true});
	};

	function capitalizeFirstLetter(string)
	{
	    return string.charAt(0).toUpperCase() + string.slice(1);
	}

    // TODO: Change regions
    regions = ["africa","asia","centralamerica","easteurope","northafr","pacificislands","southamerica","caribbean"];
    $(document).on('submit', '#searchForm', function(ev) {
    	ev.preventDefault();
    	var query = "http://www.peacecorps.gov/api/v1/openings/";

    	// Handle regions
    	var selectedCountries = $("#countries").val();
    	if (selectedCountries) {
	    	firstRegion = true;
	    	for(var i=0; i<selectedCountries.length; i++) {
	    		if (regions.indexOf(selectedCountries[i]) > -1) {
	    			if (firstRegion) {
	    				query += "?region=" + selectedCountries[i];
	    				firstRegion=false;
	    			} else {
	    				query += "&region=" + selectedCountries[i];
	    			}
	    		}
	    	}
    	}

    	// Handle countries
    	if (selectedCountries) {
	    	firstCountry = true;
	    	for(var i=0; i<selectedCountries.length; i++) {
	    		if (regions.indexOf(selectedCountries[i]) == -1) {
	    			if (firstCountry) {
	    				query += "?country=" + selectedCountries[i];
	    				firstCountry=false;
	    			} else {
	    				query += "&country=" + selectedCountries[i];
	    			}
	    		}
	    	}
    	}

    	// Handle sectors
    	var selectedSectors = $("#sectors").val();
    	if (selectedSectors) {
	    	firstSector = true;
	    	for(var i=0; i<selectedSectors.length; i++) {
				if (firstSector) {
					query += "?sector=" + selectedSectors[i];
					firstSector=false;
				} else {
					query += "&country=" + selectedSectors[i];
				}
	    	}
	    }

    	// Handle languages
    	var selectedLanguages = $("#languages").val();
    	if (selectedLanguages) {
	    	firstLanguage = true;
	    	for(var i=0; i<selectedLanguages.length; i++) {
				if (firstLanguage) {
					query += "?language=" + selectedLanguages[i];
					firstLanguage=false;
				} else {
					query += "&language=" + selectedLanguages[i];
				}
	    	}
	    }

	    // Handle couples
	    if($("#couples").is(':checked')) {
	    	query += "?couples=true";
	    }

	    var keyword = $("#keyword").val();
	    if(keyword) {
	    	query += "?keyword=" + keyword;
	    }

    	console.log(query);

	    getOpeningsInner = function(openings) {
			drawTable(openings['results']);
			$("#count").html(openings['count']);
			previous = openings['previous'];
			next = openings['next'];

			if (openings['previous']) {
				$("#previous").css('visibility', 'visible');
			} else {
				$("#previous").css('visibility', 'hidden');
			}
			if (openings['next']) {
				$("#next").css('visibility', 'visible');
			} else {
				$("#next").css('visibility', 'hidden');
			}
	    };

	    getOpenings(getOpeningsInner, query);
	 });

	function getOpenings(callback, url){
		$.ajax({
		    url: url,
		    type: 'GET',
		    success: function(data) { 
		      callback(data);
		    }
		});
	};

	/*  callback: callback function
	    passes a list of regions to callback
	    ex: [africa, easteurope]
	*/
	function getRegions(callback){
	  $.ajax({
	    url: 'http://www.peacecorps.gov/api/v1/geography/regions/',
	    type: 'GET',
	    success: function(data){
	      regions_map = new Object();
	      var regions = [];

	      for (var i = 0; i < data.length; i++){
	        regions.push(data[i]['slug']);
	        regions_map[data[i]['slug']] = data[i]['name'];
	      }
	      callback(regions);
	    }
	  });
	}

	/*
	  callback: callback function
	  passes an object that maps regions to corresponding countries to callback function

	  ex: {africa: [congo, nigeria], asia: [thailand, laos]}

	*/
	function getCountriesByRegion(callback){
	  getRegions(function(regions){
	    // initialize hashmap
	    var map = new Object();
	    for (var i = 0; i < regions.length; i++){
	      map[regions[i]] = []
	    }
	    // get countries
	    $.ajax({
	      url: 'http://www.peacecorps.gov/api/v1/geography/countries/?current=true',
	      type: 'GET',
	      success: function(data){
	        for (var i = 0; i < data.length; i++){
	          map[data[i]['region']].push(data[i]);
	          countries_map[data[i]['slug']] = data[i]['name'];
	        }
	        callback(map);
	      }
	    });
	  }); 
	}

	getCountriesByRegion(function(regions){
		$("#countries").find('option').remove().end();
		for (region in regions) {
			$("#countries").append($("<option />").val(region).html(regions_map[region]));
			for (country in regions[region]) {
				var country = regions[region][country];
				$("#countries").append($("<option />").val(country['slug']).html("&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;" + country['name']));
			}
		}
	});

	$(document).on('click', '#previous', function(ev) {
		getOpenings(getOpeningsInner, previous);
	});

	$(document).on('click', '#next', function(ev) {
		getOpenings(getOpeningsInner, next);
	});

  </script>
  </head>
  <body>
  	<form id="searchForm">
  	<section>
  	Where do you want to go? <br>
  	<select id="countries" multiple>
  	</select>
  	</section>
  	<section>
  	What do you want to do? <br>
  	<select id="sectors" multiple>
  	<option value="agriculture">Agriculture</option>
  	<option value="communityeconomicdevelopment">Community Economic Development</option>
  	<option value="education">Education</option>
  	<option value="environment">Environment</option>
  	<option value="health">Health</option>
  	<option value="youthindevelopment">Youth in Development</option>
  	</select>
  	</section>
  	<section>
  	Language Requirement <br>
  	<select id="language" multiple>
  	<option value="norequirement">No Requirement</option>
  	<option value="french">French</option>
  	<option value="spanish">Spanish</option>
  	<option value="anyromancelanguage">Any Romance Language</option>
  	<option value="russian">Russian</option>
  	<option value="other">Other</option>
  	</select>
  	</section>
  	<section>
  	Skills Requirement (select all that you meet) <br>
  	<select id="skills" multiple>
  	<option value="norequirement">No Requirement</option>
  	<option value="bachelors">BA/BS</option>
  	<option value="registerednurse">Registered nurse</option>
  	<option value="fulltimeexperience">Full time experience in relevant job sector</option>
  	</select>
  	</section>
  	<footer>
  	Departure between 
  	<select>
  	<option value="january">January</option>
  	<option value="february">February</option>
  	<option value="march">March</option>
  	<option value="april">April</option>
  	<option value="may">May</option>
  	<option value="june">June</option>
  	<option value="july">July</option>
  	<option value="august">August</option>
  	<option value="september">September</option>
  	<option value="january">October</option>
  	<option value="january">November</option>
  	<option value="january">December</option>
  	</select>
  	<select>
  	<option value="2015">2015</option>
  	<option value="2016">2016</option>
  	</select>
  	and 
  	<select id="month">
  	<option value="january">January</option>
  	<option value="february">February</option>
  	<option value="march">March</option>
  	<option value="april">April</option>
  	<option value="may">May</option>
  	<option value="june">June</option>
  	<option value="july">July</option>
  	<option value="august">August</option>
  	<option value="september">September</option>
  	<option value="january">October</option>
  	<option value="january">November</option>
  	<option value="january">December</option>
  	</select>
  	<select id="year">
  	<option value="2015">2015</option>
  	<option value="2016">2016</option>
  	</select>
  	</footer>
  	<section>
  	<input type="checkbox" id="couples" name="accepts_couples" value="true">Accepts Couples
  	</section>
  	<section>
  	Keyword Search
  	<input type="text" id="keyword" name="keyword">
  	</section>
  	<footer>
  	<input type="submit" value="Update results">
  	</footer>
  	</form>
    <div id="chart_div"></div>

    <div id="results_div">
    	<label id="count"></label> opening(s). Click on a column header to sort.
    	<div id="results_table"></div>
    	<button id="previous" style="visibility:hidden">Previous Page</button><button id="next" style="visibility:hidden">Next Page</button>
   	</div>
  </body>
</html>